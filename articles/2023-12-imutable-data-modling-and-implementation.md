---
title: "Viewっていいよね"
emoji: "🦍"
type: "tech"
topics:
  - "イミュータブルデータモデル"
  - "設計"
  - "SQL"
published: false
published_at: null
publication_name: "micin"
---

## TL;DR

1. イミュータブルデータモデルを実装するときに、Viewを使うといい
2. tblsを使うと、Viewと参照下のテーブルの関係を可視化しやすい

## Viewとは何か

Viewは、RDMSにおける、SQLの結果をテーブルのように扱える仮想的なテーブルです。
物理的にはデータは保存されていませんが、テーブルと同じように扱えるため、同じSQLを複数箇所で使いまわすことができます。
ORMを使っている場合も、Viewはテーブルと同じように扱えるため、複数テーブルに対するクエリを持ったViewを擬似的に一つのテーブルとして扱うことができます。

## イミュータブルデータモデルとView

### イミュータブルデータモデルとは何か

一言で言うとUPDATE句を使わないデータモデルの考え方です。エンティティをリソースとイベントに分けて考え、更新についてはイベントを追加することで実現します。
状態のスナップショットではなく、事実の記録をデータベースに保存することで以下のメリットがあります。

- 更新前の過去の状態を確認できる
- 更新のロジックの複雑さを減らせる
- 過去の記録が消えないため、データの信頼性を担保できる

イミュータブルデータモデリングに関して詳しく知りたい方は、下記の記事を参考にしてください。
[kawasima/イミュータブルデータモデル](https://scrapbox.io/kawasima/%E3%82%A4%E3%83%9F%E3%83%A5%E3%83%BC%E3%82%BF%E3%83%96%E3%83%AB%E3%83%87%E3%83%BC%E3%82%BF%E3%83%A2%E3%83%87%E3%83%AB)

### イミュータブルデータモデルの課題とViewの活用

イミュータブルデータモデルは素晴らしい考え方ですが、下記のようなことが起こります。

- テーブル数が多くなる
- テーブルの構造が複雑になる
- インピーダンスミスマッチが発生する

これらは、悪いことというよりは、複雑なデータモデルを実装するときには避けて通れない課題です。
しかし、Viewを使うことで、これらの課題を解決することができます。

（ここに具体例を書く）

## tblsとView

Viewはとても便利ですが、Viewの管理はテーブルの管理よりも煩雑です。
なぜならViewはテーブルとは違い、下記のような特徴があるためです。

- 複数のテーブル定義を参照できる
- 外部キー等でER図上から他テーブルの関連を表示できない

このような特徴があるため、Viewの管理はテーブルの管理よりも煩雑になります。
しかし、tblsを使うことで、Viewの管理を簡単にすることができます。

### tblsとは何か

既存のDBスキーマからER図、テーブル一覧、テーブル詳細などのドキュメントを生成するツールです。
tblsについては下記の記事でより詳しく書いていますので、そちらを参考にしてください。
https://zenn.dev/micin/articles/2023-12-05-majimaccho-tbls#tbls%E3%81%A8%E3%81%AF

### tblsを使うと、Viewと参照下のテーブルの関係を可視化しやすい

tblsは特に設定をしなくとも、Viewと参照下のテーブルの関係を表示してくれます。
![tblsのViewで参照しているテーブルが一覧になって表示されている図](/images/tbls-view.png)

また、Viewpointを定義し、その中に関連するViewをまとめることで、ユースケースとViewの関係をわかりやすくすることができます。
下の画像では書籍情報に関連するテーブルのまとまりをViewpointとして定義しており、そのテーブルと参照しているViewを同じViewpointにまとめています。
![Viewpointを定義して、Viewをまとめて表示している図](/images/tbls-view-in-viewpoint.png)


tblsとViewを組み合わせて使うことで、Viewの内容をよりわかりやすくドキュメント化することができます。
また、Viewpoint内のテーブルの参照され方もわかりやすくなるため、よりViewpointsの情報を活用しやすくなります。

## 参考文献