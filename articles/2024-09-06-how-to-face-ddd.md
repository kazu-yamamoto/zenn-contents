---
title: "DDDとの付き合い方"
emoji: "🦍"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ['DDD']
published: false
---

## この記事の目的

以下の3つのDDDに関する書籍を読んだ上で、DDDとの向き合い方を整理したい

- [エリック・エヴァンスのドメイン駆動設計: ソフトウェアの核心にある複雑さに立ち向かう](https://amzn.asia/d/1m11xqN)
- [ドメイン駆動設計をはじめよう ―ソフトウェアの実装と事業戦略を結びつける実践技法](https://www.oreilly.co.jp/books/9784814400737/)
- [Domain Modeling Made Functional: Tackle Software Complexity with Domain-Driven Design and F#](https://amzn.asia/d/ejmv9n3)

## 想定読者

DDDを学んだがどこまで忠実にやるべきか迷っている人

## DDDの重要なこと

DDDはソフトウェア開発で非常に重要なことを伝えています。それは、ソフトウェア開発者が、事業活動を分析して、事業・業務領域の専門家（ドメインエキスパート）と共同して、チームで同じ言葉（ユビキタス言語）を使うようにすることです。
その上で、その言葉が適応できる範囲を「区切られた文脈（境界づけられたコンテキスト）」として整理することは有用でしょう。

### 事業活動を分析する

ソフトウェアを開発する上で、事業を理解することは非常に重要です。
~~事業を理解しないで画面イメージだけを渡されてコードを書くだけというのは職業エンジニアの仕事ではありません~~

事業活動の分析というと大まかに下記のようなものがあります

- 顧客に提供している価値は何か
- どの事業でどの程度収益を上げているか、上げる見込みか
- 何にどのくらいコストがかかっているか
- 他社と差別化される点は何か

これらのことは、ソフトウェアの設計において非常に重要です。
なぜなら変更可能性がどこまであるか、どの程度ロジックや依存関係が複雑になるのか、どこまで柔軟性を許容するかを決定する要素だからです。
事業活動を深く理解するとこで、課題解決に適した変化に強いモデルを作ることができるようになります。

### 事業活動を分解する

ドメイン（事業領域）、サブドメイン（業務領域）に分解してさらに以下について分析します
- それが事業の中核なのか
- 一般的な領域か補完的な領域

これらは業務ロジック（ドメインロジック）の複雑さと、競合他社との差別化になるかどうかによって決定されます。

![img](/images/start-ddd-image1-1.png)
「ドメイン駆動設計を始めよう」より

### 「同じ言葉（ユビキタス言語）」 を作る

ドメインの専門家と同じ言葉を使うことは、より正確なコミュニケーションにつながりますし、
コミュニケーションの齟齬はすぐ品質低下につながります

ソフトウェアエンジニアから、対象の領域がどう見えているかのフィードバックにもなります。
いろんな関係者が一つのものをさまざまな呼び方をしていたり、開発チームだけ簡易な言葉を使っていると、認識の齟齬が生まれやすく、バグや手戻りデータ不整合、アーキテクチャ設計の失敗などの原因になります。

### 区切られた文脈（境界づけられたコンテキスト）を発見する

同じ言葉を話しているように見えるけれども指しているものが違うというような領域同士をDDDの用語では
境界づけられたコンテキストと呼びます。
システムを正しく分割することは非常に難しく、失敗すると大きな痛みを伴います。
この境界づけられたコンテキストはシステムを分割する上での目安として知られています。
特に書籍の「マイクロサービス」でサービスを分割する単位として境界づけられたコンテキストは紹介され、一般的にも知られています。
マイクロサービスに限らず、ネームスペースを分けたり、DBを分割したり、非同期のアーキテクチャにしたりする単位としてこの境界は有用です。

## DDDであまり参考にならないこと

### 実装に関しては不十分な点が目立つ

多くの方が指摘されているDDDの問題ですが、特にEric EvanceのDDDの実装パターンは、今現在ではあまり有用なものではありません。
Eric Evanceのドメイン駆動設計はPoEAA^[[エンタープライズアプリケーションアーキテクチャパターン](https://amzn.asia/d/5lJ4D2X)]の時代に書かれており、その影響を強く受けています。
また、[ファウラー自身が指摘しているように](https://martinfowler.com/eaaDev/)、イベントソーシングといった現代の設計において重要な概念が含まれていないといった問題もあります。

また、PoEAAはRuby on Railsが世を席巻する以前に書かれたもので、アクティブレコードをベースとしたフレームワークがここまで広く使われることは想定されていません。

「ドメイン駆動設計を始めよう」では一部にイベントソーシングなどの、アップデートされた実装方法の話が出ていますが、いまだに古く感じられる内容も多いです。
~~特にEqualsメソッドをオーバライドして比較演算子(==)でオブジェクトの等価性を検証できるようにするとかは絶対に辞めてほしいと思いました。~~

とは言え、DDDやPoEAAのパターンのうち現代でも役に立つものはありますし、共通の語彙として理解しておいて損はないとも思います。

### （リレーショナル）データベース設計の話が一切出てこないことはモデリング・設計論としては不十分

ここが筆者が最も大きい課題と感じている点です。

現代のDDDが必要になるような開発においてリレーショナルデータベース（RDB）は多くの場合必須です。

一時的にドキュメント指向のデータベースの流行もありましたが、一定規模を超えるとデータの整合性を担保することが難しいため、限られたユースケースのみで使われることが多いと思います。

[そーだいさん](https://x.com/soudai1025)が[失敗から学ぶ データベースの正しい歩き方](https://gihyo.jp/book/2019/978-4-297-10408-5)を執筆された時におっしゃっている通りです。

> 「⁠データベースの寿命はアプリケーションよりも長い」が筆者の持論です。なぜならば，データベースはサービス開発当初から存在することが一般的で，アプリケーションコードのようにリプレースされることは稀だからです。また複数のサービスから参照されることも多々あり，その場合，最初に使われていたサービスが終了しても，データベースはほかのサービスとともに運用され続けます。

https://gihyo.jp/book/2019/978-4-297-10408-5/content/preface

DDDを実践する際にドメインモデリングをすると思いますが、エンティティの洗い出し→集約の設計をする際にDBの論理設計を行うのが一連のフローとして、適切ではないでしょうか。

## DDDに対する所感

DDDはソフトウェアエンジニアが自分たちの専門領域だけに閉じずに、事業にしっかり踏み込んでいくことや対話を通して同じ言葉（ユビキタス言語）を構築することだったり、ソフトウェア設計に必要な事業の分析の観点を提供してくれる枠組みとして、いまだに重要な考えだと思います。
実装に関してはDDDのものは1つの例に過ぎないというふうに受け止めて、さまざまな角度から良い設計ができるようにする学習が必要だと感じています。

