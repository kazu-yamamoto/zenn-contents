---
title: "ドラフト：ロギングについて"
emoji: "🦍"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# サーバーログの設計

## このドキュメントの目的

このドキュメントは、ログの設計について、特にAPIサーバーのログについてチームで共通の認識を醸成することを目的としています。

## TR;DR

- 本番環境運用時に問題があった時に困らないようにする
- ログレベルは適切に設定する。info, warn, errorが基本
- 運用時の監視ツールの設定も想定してログを出力する
- 異常系のログには、アラート時の対応を明確にするために、共通の項目を出力する

## ログを出力する目的

ログは、アプリケーションの機能要求には含まれないですが、運用時のトラブルシューティングや監視のために必要な情報を提供します。
定常状態のログのカウント等を見て正常に動作しているかを確認したり、異常状態のログを見て異常が発生していることを検知することができます。

## 前提

本ドキュメントでは、運用監視の観点から、本番環境でのログ出力について記載します。  
そのため、顧客との連絡を行う担当者との連携を含めた運用体制まで考慮する必要があります。  
問題が発生した際の対応は、開発者だけでは決められない部分もあるため、適宜担当者との連携を取りながら設計を行ってください。

また、本ドキュメントでは、APIサーバーのエラーハンドリングが適切に行われていることを前提としています。  
特に、ユーザーに向けたエラーメッセージが適切に表示されることが重要です。

APIサーバーのエラーハンドリングについては、[APIのエラーハンドリング方針](./api-error-handling.md)を参照してください。

## ログレベル

ログレベルを適切に設定することは、ログを有効に活用していく上で重要です。

ログレベルには一般的に以下のようなものがあります。

| ログレベル | ユースケース |
| --- | --- |
| debug | 開発時のデバッグ |
| info | リクエストの受け取り、レスポンスの送信 |
| warn | システムが正常に動作する範囲のエラー |
| error | 予期せぬエラー |
| fatal | システム停止 / データ不整合 |

## 設定するログ

上記のうち、本番環境で出力するログレベルは、`info`, `warn`, `error` が基本となりますが、一部のケースで`fatal`を出力することもありえます。

### info

infoログは正常系の動作を確認するために出力します。
本プロダクトでは、ミドルウェアで全てのリクエスト、レスポンスをログに出力するように設定されています。

そのため、ほとんどのケースではinfoログを意図的に出力する必要はありませんが、特定の処理の開始、終了、成功、失敗などをログに出力することで、処理の流れを把握することができます。

具体例を挙げると、外部APIへのリクエストやバッチ処理の開始、終了はinfoログで出力することが考えられます。
また、長時間実行される処理の進捗を確認するために、途中経過をinfoログで出力することも有用です。

### warn

warnログは、一定予見されるエラーをログに出力するために使用します。
バリデーションエラーや、リクエストのパラメータが不正な場合など、それ自体が問題ではないが、短時間に大量に発生すると問題となるようなエラーを出力します。

### error

errorログは、問題が発生していることを示すために使用します。
外部へのAPIリクエストの失敗、データベースへのアクセスエラー、アプリケーション内での例外など、問題が発生している場合に出力します。

### fatal

fatalログは、システム停止やデータ不整合などのマニュアルでの作業が必要な問題が発生した場合に出力します。
fatalログが出力された場合、自動での復旧が難しい問題が発生していることを示します。

## 運用時の監視

運用時には、上記のログレベルに合わせて監視、アラートを設定します。

| ログレベル | 本番環境での出力 | ログから知りたいこと | アラート基準 |
| --- | --- | --- | --- |
| debug | X | - | - |
| info | O | 正常に利用されているか | 定常の状態よりもログが少ない |
| warn | O | 一件では問題にならない程度のエラーがあるか | 定常の状態よりもwarnログが多い |
| error | O | 問題が発生しているか | 1件以上のerrorログが出力された場合 |
| fatal | O | マニュアルでの作業が必要か | 1件以上のfatalログが出力された場合 |

## 全てのログに共通の項目

全てのログには、以下の項目を出力するように設定します。
これらは本プロダクトのデフォルトのロガーに設定されています。

| 項目 | 説明 |
| --- | --- |
| Request Id | リクエストごとに一意のID |
| User-Agent | リクエストのUser-Agent |
| GraphQL Operation Name | リクエストのGraphQLのクエリ・ミューテーション名 |

## 異常系のログに含める項目

異常系のログは、監視ツールからアラートが発生した際に、対応を迅速に行うために、以下の項目を出力するように設定します。

| 項目 | キー名 | 説明 |
| --- | --- | --- |
| 何が起きたか | `whatHappened` | 端的に何が起きたか |
| なぜ起きたか | `why` | なぜその問題が発生した原因 |
| ユーザーへの影響 | `impactToUser` | ユーザーにどのような影響があるか |
| 必要な対応 | `requiredAction` | どのような対応が必要か |

ログにこれらの項目を含めることで、アラートが発生してから対応を考えるのではなく、開発の時点で事前に対応を考えることができます。
障害発生時は、焦りなどから冷静な判断が難しくなることがあるため、事前に対応を考えておくことが重要です。

このようにログを出力するために、本プロダクトでは、ログの関数を用意しており、これらの項目を引数として渡すことで、ログに出力することができます。
また、デフォルトのロガー（api/src/lib/logger.tsのloggerインスタンス）は、特定のファイル以外からのインポートは禁止されており、
代わりに、`api/src/lib/logger.ts`に定義されている関数(`logInfo`, `logWarn` `logError`, `logFatal`)を使用することで、ログを出力します。

ログの関数は下記のように実装されています。

```typescript
// src/lib/logger.ts
type AnomalyLogArgs = Record<string, unknown> & {
  whatHappened: string
  why: string
  impactToUser: string
  requiredAction: string
}

export const logWarn = (args: AnomalyLogArgs) => logger.warn(args)

export const logError = (args: AnomalyLogArgs) => logger.error(args)

export const logFatal = (args: AnomalyLogArgs) => logger.fatal(args)
```

利用時には、以下のように引数を渡してログを出力します。

```typescript
// controller.ts

import { logError } from 'src/lib/logger'

const controller = async (req: Request, res: Response) => {
  
// 何かしらの処理
  
logFatal({
  whatHappened: 'OO実行に失敗した',
  why: 'OO APIへのリクエストがタイムアウトしたため。',
  impactToUser: 'データの不整合が発生する可能性がある',
  requiredAction: 'APIリクエストを再度実行し、OOデータを登録する',
})

```